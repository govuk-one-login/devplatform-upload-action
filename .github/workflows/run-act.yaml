name: Run act

on:
  workflow_dispatch:
  push:

defaults:
  run:
    shell: bash
    working-directory: ./

jobs:
  check-actions:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: Checkout devplatform-demo-sam-app repo
        uses: actions/checkout@v4
        with:
          repository: 'govuk-one-login/devplatform-demo-sam-app'
          ref: 'bau-spike-on-act'
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
          token: ${{ secrets.DEMO_REPO_TOKEN }}
          path: 'devplatform-demo-sam-app'

      - name: update workflows
        run: sed -i 's/devplatform-upload-action*/devplatform-upload-action@${{ github.sha }}/' ./devplatform-demo-sam-app/.github/workflows/sam-app2-deploy-testing-upload-action.yml

      - name: check workflow
        run: cat ./devplatform-demo-sam-app/.github/workflows/sam-app2-deploy-testing-upload-action.yml

      - name: Install act
        run: curl --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash

      - name: Run act
        run: |
          ./bin/act -s ACT_BUCKET_NAME=${{ secrets.ACT_BUCKET_NAME }} \
          -s SIGNING_PROFILE_NAME=${{ secrets.SIGNING_PROFILE_NAME }} \
          -s ACT_ROLE_ARN=${{ secrets.ACT_ROLE_ARN }} \
          --env ACTIONS_ID_TOKEN_REQUEST_URL=$ACTIONS_ID_TOKEN_REQUEST_URL \
          --env ACTIONS_ID_TOKEN_REQUEST_TOKEN=$ACTIONS_ID_TOKEN_REQUEST_TOKEN

      - name: Poll stack for updates
        uses: govuk-one-login/github-actions/sam/check-stack-updated@5014b60a89f930b5d7195a7725008bef1234fd45 #bau-new-cloudformation-polling-action
        with:
          stack-name: ${{ secrets.STACK_NAME }}
          gh-polling-role: ${{ secrets.POLLING_ROLE }}